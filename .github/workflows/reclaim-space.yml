name: Reclaim
on:
  #push:
  workflow_dispatch:
jobs:
  # This workflow contains a single job called "build"
  reclaim:
    # The type of runner that the job will run on
    runs-on:
      group: Bitrise-M4Pro
      labels: [bitrise_pool_name:M4ProXL]

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Resize APFS Container
        if: false
        shell: bash
        # We set space_to_claim to 0 to claim all available space, 
        # as referenced in your script logic
        env:
          space_to_claim: "0" 
        run: |
          #!/usr/bin/env bash
          set -e
          set -o pipefail
          
          # Find the Container ID of the root volume directly
          CONTAINER_ID=$(diskutil info / | grep "Part of Whole" | awk '{print $4}')
          
          echo "Root Container identified as: $CONTAINER_ID"
          
          # Get size before
          BEFORE_BYTES=$(diskutil info $CONTAINER_ID | grep "Disk Size" | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Resize to fill available space (0 = max)
          sudo diskutil apfs resizeContainer $CONTAINER_ID 0
          
          # Get size after
          AFTER_BYTES=$(diskutil info $CONTAINER_ID | grep "Disk Size" | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Calculate difference
          DIFF_BYTES=$((AFTER_BYTES - BEFORE_BYTES))
          echo "Claimed ${DIFF_BYTES} bytes"
          echo "BYTES_RECLAIMED=${DIFF_BYTES}" >> $GITHUB_ENV
      - name: Cleanup Simulators
        env:
          os_versions_to_include: "17.0"
        run: |
          #!/usr/bin/env bash
          set -e
          
          # --- Helper Functions ---
          print_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
          
          # --- Main Script ---
          
          print_info "Shutting down booted simulators..."
          xcrun simctl shutdown all || true
          
          # 1. Normalize Input
          # If input is empty, we don't filter (delete all).
          if [[ -z "$os_versions_to_include" ]]; then
              print_info "No versions to keep specified. Deleting all..."
              xcrun simctl delete unavailable
              xcrun simctl erase all
              exit 0
          fi
          
          # Convert "17.0" -> "17-0"
          NORMALIZED_VERSIONS=$(echo "$os_versions_to_include" | sed 's/\./-/g')
          
          print_info "--- Configuration ---"
          print_info "Input Raw:        $os_versions_to_include"
          print_info "Searching for:    $NORMALIZED_VERSIONS"
          print_info "---------------------"
          
          if ! command -v jq &> /dev/null; then
              echo "jq is required."
              exit 1
          fi
          
          JSON_OUTPUT=$(xcrun simctl list devices -j)
          ARGS_JSON=$(echo "$NORMALIZED_VERSIONS" | jq -R . | jq -s .)
          
          print_info "--- analyzing runtimes ---"
          
          # We perform the logic in a loop to print the decision for every runtime found
          echo "$JSON_OUTPUT" | jq -r '.devices | keys[]' | while read -r runtime_key; do
              
              # Check if this runtime key contains ANY of our allowed strings
              # We use grep for a simple substring check here for visibility
              should_keep=false
              for version in $NORMALIZED_VERSIONS; do
                  if [[ "$runtime_key" == *"$version"* ]]; then
                      should_keep=true
                      break
                  fi
              done
          
              if [ "$should_keep" = true ]; then
                  echo -e "\033[32m[KEEP]\033[0m   $runtime_key matches '$version'"
              else
                  echo -e "\033[31m[DELETE]\033[0m $runtime_key (No match)"
                  
                  # Get all UDIDs for this specific runtime and delete them
                  # We extract just the UDIDs for this specific Key
                  UDIDS=$(echo "$JSON_OUTPUT" | jq -r --arg key "$runtime_key" '.devices[$key][].udid')
                  
                  if [[ -z "$UDIDS" ]]; then
                       echo "         (No devices exist in this runtime to delete)"
                  else
                       # Delete them
                       echo "$UDIDS" | while read -r udid; do
                          echo "         Deleting device: $udid"
                          xcrun simctl delete "$udid"
                       done
                  fi
              fi
          done
          
          print_info "--------------------------"
          print_info "Pruning 'unavailable' devices..."
          xcrun simctl delete unavailable
          print_info "Done."
        
