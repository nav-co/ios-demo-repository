name: Reclaim
on:
  #push:
  workflow_dispatch:
jobs:
  # This workflow contains a single job called "build"
  reclaim:
    # The type of runner that the job will run on
    runs-on:
      group: Bitrise-M4Pro
      labels: [bitrise_pool_name:M4ProXL]

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Resize APFS Container
        if: false
        shell: bash
        # We set space_to_claim to 0 to claim all available space, 
        # as referenced in your script logic
        env:
          space_to_claim: "0" 
        run: |
          #!/usr/bin/env bash
          set -e
          set -o pipefail
          
          # Find the Container ID of the root volume directly
          CONTAINER_ID=$(diskutil info / | grep "Part of Whole" | awk '{print $4}')
          
          echo "Root Container identified as: $CONTAINER_ID"
          
          # Get size before
          BEFORE_BYTES=$(diskutil info $CONTAINER_ID | grep "Disk Size" | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Resize to fill available space (0 = max)
          sudo diskutil apfs resizeContainer $CONTAINER_ID 0
          
          # Get size after
          AFTER_BYTES=$(diskutil info $CONTAINER_ID | grep "Disk Size" | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Calculate difference
          DIFF_BYTES=$((AFTER_BYTES - BEFORE_BYTES))
          echo "Claimed ${DIFF_BYTES} bytes"
          echo "BYTES_RECLAIMED=${DIFF_BYTES}" >> $GITHUB_ENV
      - name: Cleanup Simulators
        env:
          os_versions_to_include: "17.0"
        run: |
          #!/usr/bin/env bash
          set -e
          
          # --- Helper Functions ---
          print_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
          print_success() { echo -e "\033[32m[KEEP]\033[0m $1"; }
          print_delete() { echo -e "\033[31m[DELETE]\033[0m $1"; }
          
          get_simulator_size() {
            local sim_path="$HOME/Library/Developer/CoreSimulator/Devices"
            if [ -d "$sim_path" ]; then
              du -sh "$sim_path" | awk '{print $1}'
            else
              echo "0B"
            fi
          }
          
          get_free_space() {
            df -h / | tail -1 | awk '{print $4}'
          }
          
          # --- Main Script ---
          
          print_info "--- Pre-Cleanup Statistics ---"
          START_SIM_SIZE=$(get_simulator_size)
          START_FREE_SPACE=$(get_free_space)
          print_info "Current Simulator Folder Size: $START_SIM_SIZE"
          print_info "Current Free Disk Space:       $START_FREE_SPACE"
          print_info "------------------------------"
          
          print_info "Shutting down booted simulators..."
          xcrun simctl shutdown all || true
          
          # 1. Normalize Input
          if [[ -z "$os_versions_to_include" ]]; then
              print_info "No versions to keep specified. Deleting all..."
              xcrun simctl delete unavailable
              xcrun simctl erase all
              
              # Skip the detailed logic loop if we just wiped everything
              print_info "--- Post-Cleanup Statistics ---"
              END_SIM_SIZE=$(get_simulator_size)
              END_FREE_SPACE=$(get_free_space)
              print_info "Old Size: $START_SIM_SIZE -> New: $END_SIM_SIZE"
              print_info "Old Free: $START_FREE_SPACE -> New: $END_FREE_SPACE"
              exit 0
          fi
          
          # Convert "17.0" -> "17-0"
          NORMALIZED_VERSIONS=$(echo "$os_versions_to_include" | sed 's/\./-/g')
          
          print_info "--- Configuration ---"
          print_info "Input Raw:        $os_versions_to_include"
          print_info "Searching for:    $NORMALIZED_VERSIONS"
          print_info "---------------------"
          
          if ! command -v jq &> /dev/null; then
              echo "jq is required."
              exit 1
          fi
          
          JSON_OUTPUT=$(xcrun simctl list devices -j)
          
          print_info "--- Analyzing Runtimes ---"
          
          # Loop through every Runtime found on the system
          echo "$JSON_OUTPUT" | jq -r '.devices | keys[]' | while read -r runtime_key; do
              
              should_keep=false
              # Check if this runtime key contains ANY of our allowed strings
              for version in $NORMALIZED_VERSIONS; do
                  if [[ "$runtime_key" == *"$version"* ]]; then
                      should_keep=true
                      break
                  fi
              done
          
              if [ "$should_keep" = true ]; then
                  print_success "  $runtime_key matches '$version'"
              else
                  # No match found, delete devices in this runtime
                  UDIDS=$(echo "$JSON_OUTPUT" | jq -r --arg key "$runtime_key" '.devices[$key][].udid')
                  
                  if [[ -z "$UDIDS" ]]; then
                       # No devices existed for this runtime anyway
                       print_delete "$runtime_key (No devices found)"
                  else
                       print_delete "$runtime_key (Deleting devices...)"
                       echo "$UDIDS" | while read -r udid; do
                          echo "         Deleting: $udid"
                          xcrun simctl delete "$udid"
                       done
                  fi
              fi
          done
          
          print_info "--------------------------"
          print_info "Pruning 'unavailable' devices..."
          xcrun simctl delete unavailable
          
          print_info "--- Post-Cleanup Statistics ---"
          END_SIM_SIZE=$(get_simulator_size)
          END_FREE_SPACE=$(get_free_space)
          
          print_info "Old Simulator Size: $START_SIM_SIZE -> New: $END_SIM_SIZE"
          print_info "Old Free Space:     $START_FREE_SPACE -> New: $END_FREE_SPACE"
          print_info "-------------------------------"
          print_info "Cleanup Done."
        
