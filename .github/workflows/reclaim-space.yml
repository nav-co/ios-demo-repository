name: Reclaim
on:
  #push:
  workflow_dispatch:
jobs:
  # This workflow contains a single job called "build"
  reclaim:
    # The type of runner that the job will run on
    runs-on:
      group: Bitrise-M4Pro
      labels: [bitrise_pool_name:M4Pro]

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Resize APFS Container
        if: false
        shell: bash
        # We set space_to_claim to 0 to claim all available space, 
        # as referenced in your script logic
        env:
          space_to_claim: "0" 
        run: |
          #!/usr/bin/env bash
          set -e
          set -o pipefail
          
          # Find the Container ID of the root volume directly
          CONTAINER_ID=$(diskutil info / | grep "Part of Whole" | awk '{print $4}')
          
          echo "Root Container identified as: $CONTAINER_ID"
          
          # Get size before
          BEFORE_BYTES=$(diskutil info $CONTAINER_ID | grep "Disk Size" | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Resize to fill available space (0 = max)
          sudo diskutil apfs resizeContainer $CONTAINER_ID 0
          
          # Get size after
          AFTER_BYTES=$(diskutil info $CONTAINER_ID | grep "Disk Size" | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Calculate difference
          DIFF_BYTES=$((AFTER_BYTES - BEFORE_BYTES))
          echo "Claimed ${DIFF_BYTES} bytes"
          echo "BYTES_RECLAIMED=${DIFF_BYTES}" >> $GITHUB_ENV
      - name: Cleanup Simulators
        env:
          os_versions_to_keep: "26.2"
        run: |
          #!/usr/bin/env bash
          set -e
          
          # --- Helper Functions ---
          print_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
          print_success() { echo -e "\033[32m[KEEP]\033[0m $1"; }
          print_delete() { echo -e "\033[31m[DELETE]\033[0m $1"; }
          
          get_simulator_size() {
            local sim_path="$HOME/Library/Developer/CoreSimulator/Devices"
            if [ -d "$sim_path" ]; then
              du -sh "$sim_path" | awk '{print $1}'
            else
              echo "0B"
            fi
          }
          
          get_free_space() {
            df -h / | tail -1 | awk '{print $4}'
          }
          
          # --- Main Script ---
          
          print_info "--- Pre-Cleanup Statistics ---"
          START_SIM_SIZE=$(get_simulator_size)
          START_FREE_SPACE=$(get_free_space)
          print_info "Current Simulator Folder Size: $START_SIM_SIZE"
          print_info "Current Free Disk Space:       $START_FREE_SPACE"
          print_info "------------------------------"
          
          print_info "Shutting down booted simulators..."
          xcrun simctl shutdown all || true
          
          # 1. Normalize Input
          if [[ -z "$os_versions_to_keep" ]]; then
              print_info "No versions to keep specified. Deleting all..."
              xcrun simctl delete unavailable
              xcrun simctl erase all
              
              # Skip the detailed logic loop if we just wiped everything
              print_info "--- Post-Cleanup Statistics ---"
              END_SIM_SIZE=$(get_simulator_size)
              END_FREE_SPACE=$(get_free_space)
              print_info "Old Size: $START_SIM_SIZE -> New: $END_SIM_SIZE"
              print_info "Old Free: $START_FREE_SPACE -> New: $END_FREE_SPACE"
              exit 0
          fi
          
          # Convert "17.0" -> "17-0"
          NORMALIZED_VERSIONS=$(echo "$os_versions_to_keep" | sed 's/\./-/g')
          
          print_info "--- Configuration ---"
          print_info "Input Raw:        $os_versions_to_keep"
          print_info "Searching for:    $NORMALIZED_VERSIONS"
          print_info "---------------------"
          
          if ! command -v jq &> /dev/null; then
              echo "jq is required."
              exit 1
          fi
          
          JSON_OUTPUT=$(xcrun simctl list devices -j)
          
          print_info "--- Analyzing Runtimes ---"
          
          # Loop through every Runtime found on the system
          echo "$JSON_OUTPUT" | jq -r '.devices | keys[]' | while read -r runtime_key; do
              
              should_keep=false
              # Check if this runtime key contains ANY of our allowed strings
              for version in $NORMALIZED_VERSIONS; do
                  if [[ "$runtime_key" == *"$version"* ]]; then
                      should_keep=true
                      break
                  fi
              done
          
              if [ "$should_keep" = true ]; then
                  print_success "  $runtime_key matches '$version'"
              else
                  # No match found, delete devices in this runtime
                  UDIDS=$(echo "$JSON_OUTPUT" | jq -r --arg key "$runtime_key" '.devices[$key][].udid')
                  
                  if [[ -z "$UDIDS" ]]; then
                       # No devices existed for this runtime anyway
                       print_delete "$runtime_key (No devices found)"
                  else
                       print_delete "$runtime_key (Deleting devices...)"
                       echo "$UDIDS" | while read -r udid; do
                          echo "         Deleting: $udid"
                          xcrun simctl delete "$udid"
                       done
                  fi
              fi
          done
          
          print_info "--------------------------"
          print_info "Pruning 'unavailable' devices..."
          xcrun simctl delete unavailable
          
          print_info "--- Post-Cleanup Statistics ---"
          END_SIM_SIZE=$(get_simulator_size)
          END_FREE_SPACE=$(get_free_space)
          
          print_info "Old Simulator Size: $START_SIM_SIZE -> New: $END_SIM_SIZE"
          print_info "Old Free Space:     $START_FREE_SPACE -> New: $END_FREE_SPACE"
          print_info "-------------------------------"
          print_info "Cleanup Done."
      - name: Cleanup Runtimes (OS Images)
        env:
          os_versions_to_keep: "26.2"
        run: |
          #!/usr/bin/env bash
          set -e

          # --- Helper Functions ---
          print_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
          print_success() { echo -e "\033[32m[KEEP]\033[0m $1"; }
          print_delete() { echo -e "\033[31m[DELETE]\033[0m $1"; }
          
          get_free_space() { df -h / | tail -1 | awk '{print $4}'; }

          # --- Main Script ---
          
          if ! command -v jq &> /dev/null; then
              echo "jq is required but not found."
              exit 1
          fi

          print_info "--- Pre-Cleanup Disk Space ---"
          START_FREE=$(get_free_space)
          print_info "Free Space: $START_FREE"
          print_info "Filter: Keeping versions containing '$os_versions_to_keep'"
          print_info "------------------------------"

          # Get Runtimes list in JSON
          JSON_OUTPUT=$(xcrun simctl runtime list -j 2>/dev/null || true)

          if [[ -z "$JSON_OUTPUT" ]]; then
              echo "No runtimes found or simctl failed."
              exit 0
          fi

          # We use 'values[]' to ignore the keys and just get the object data
          # We also look for .version and .name, defaulting to empty if missing
          echo "$JSON_OUTPUT" | jq -c 'values[]' | while read -r runtime_json; do
              
              # Extract data (using // "" to handle potential missing fields)
              # Note: Your JSON output shows "runtimeIdentifier" instead of "name" sometimes,
              # so we check both to be safe for filtering.
              id=$(echo "$runtime_json" | jq -r '.identifier // ""')
              version=$(echo "$runtime_json" | jq -r '.version // ""')
              runtime_id=$(echo "$runtime_json" | jq -r '.runtimeIdentifier // ""')
              
              # Combine fields for matching (e.g. "com.apple.CoreSimulator.SimRuntime.iOS-17-5")
              full_name="$id $runtime_id"
              
              # Skip if identifier is missing
              if [[ -z "$id" ]]; then continue; fi

              should_keep=false

              if [[ -n "$os_versions_to_keep" ]]; then
                  while IFS= read -r keep_v; do
                      if [[ -n "$keep_v" ]]; then
                          # Check if version (e.g. "17.5") OR identifier (e.g. "...iOS-17-5") matches
                          if [[ "$version" == *"$keep_v"* ]] || [[ "$full_name" == *"$keep_v"* ]]; then
                              should_keep=true
                              break
                          fi
                      fi
                  done <<< "$os_versions_to_keep"
              fi

              # Display Name for logs
              display_name="Runtime: $version ($runtime_id)"

              if [ "$should_keep" = true ]; then
                  print_success "$display_name"
              else
                  print_delete "$display_name"
                  
                  # Delete command
                  if xcrun simctl runtime delete "$id" 2>/dev/null; then
                       echo "         -> Deleted."
                  else
                       echo "         -> Skipped (System/Bundled runtime or read-only)."
                  fi
              fi
          done

          print_info "-------------------------------"
          print_info "--- Post-Cleanup Disk Space ---"
          END_FREE=$(get_free_space)
          print_info "Free Space: $START_FREE -> $END_FREE"
          print_info "Done."
        
