name: Reclaim
on:
  #push:
  workflow_dispatch:
jobs:
  # This workflow contains a single job called "build"
  reclaim:
    # The type of runner that the job will run on
    runs-on:
      group: Bitrise-M4Pro
      labels: [bitrise_pool_name:M4ProXL]

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Resize APFS Container
        if: false
        shell: bash
        # We set space_to_claim to 0 to claim all available space, 
        # as referenced in your script logic
        env:
          space_to_claim: "0" 
        run: |
          #!/usr/bin/env bash
          set -e
          set -o pipefail
          
          # Find the Container ID of the root volume directly
          CONTAINER_ID=$(diskutil info / | grep "Part of Whole" | awk '{print $4}')
          
          echo "Root Container identified as: $CONTAINER_ID"
          
          # Get size before
          BEFORE_BYTES=$(diskutil info $CONTAINER_ID | grep "Disk Size" | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Resize to fill available space (0 = max)
          sudo diskutil apfs resizeContainer $CONTAINER_ID 0
          
          # Get size after
          AFTER_BYTES=$(diskutil info $CONTAINER_ID | grep "Disk Size" | awk -F'[()]' '{print $2}' | awk '{print $1}')
          
          # Calculate difference
          DIFF_BYTES=$((AFTER_BYTES - BEFORE_BYTES))
          echo "Claimed ${DIFF_BYTES} bytes"
          echo "BYTES_RECLAIMED=${DIFF_BYTES}" >> $GITHUB_ENV
      - name: Cleanup Simulators
        env:
          os_versions_to_include: "17.0"
        run: |
          #!/usr/bin/env bash
          set -e
          
          # --- Helper Functions ---
          print_info() { echo -e "\033[34m[INFO]\033[0m $1"; }
          print_error() { echo -e "\033[31m[ERROR]\033[0m $1"; }
          
          get_simulator_size() {
            local sim_path="$HOME/Library/Developer/CoreSimulator/Devices"
            if [ -d "$sim_path" ]; then
              du -sh "$sim_path" | awk '{print $1}'
            else
              echo "0B"
            fi
          }
          
          # --- Main Script ---
          
          # 1. Debug: Show what is actually currently installed/created
          print_info "--- DEBUG: Current Devices List (Summary) ---"
          xcrun simctl list devices | grep "Devices" -A 20 || true
          print_info "--- End Debug ---"
          
          print_info "--- Pre-Cleanup Statistics ---"
          START_SIM_SIZE=$(get_simulator_size)
          print_info "Current Simulator Folder Size: $START_SIM_SIZE"
          
          print_info "Shutting down booted simulators..."
          xcrun simctl shutdown all || true
          
          if [[ -z "$os_versions_to_include" ]]; then
              print_info "No versions to keep specified. Deleting all..."
              xcrun simctl delete unavailable
              xcrun simctl erase all
          else
              # 2. FIX: Convert dots to hyphens (e.g., "17.0" -> "17-0")
              # This ensures it matches Apple's internal naming scheme (iOS-17-0)
              NORMALIZED_VERSIONS=$(echo "$os_versions_to_include" | sed 's/\./-/g')
              
              print_info "Raw input: $os_versions_to_include"
              print_info "Normalized filter (hyphens): $NORMALIZED_VERSIONS"
          
              if ! command -v jq &> /dev/null; then
                  print_error "jq is required."
                  exit 1
              fi
          
              JSON_OUTPUT=$(xcrun simctl list devices -j)
              ARGS_JSON=$(echo "$NORMALIZED_VERSIONS" | jq -R . | jq -s .)
          
              # 3. Find IDs to delete
              # We look for Runtime Keys that DO NOT contain our normalized version string
              IDS_TO_DELETE=$(echo "$JSON_OUTPUT" | jq -r --argjson allowed "$ARGS_JSON" '
                .devices | to_entries[] | 
                .key as $runtime | 
                select(any($allowed[]; $runtime | contains(.)) | not) |
                .value[].udid
              ')
          
              if [[ -z "$IDS_TO_DELETE" ]]; then
                  print_info "No specific device instances matched for deletion."
                  print_info "This usually means no devices exist for the versions you want to delete."
              else
                  COUNT=$(echo "$IDS_TO_DELETE" | wc -l | xargs)
                  print_info "Deleting $COUNT simulators..."
                  echo "$IDS_TO_DELETE" | xargs -I {} xcrun simctl delete {}
              fi
              
              print_info "Pruning 'unavailable' devices..."
              xcrun simctl delete unavailable
          fi
          
          print_info "--- Post-Cleanup Statistics ---"
          END_SIM_SIZE=$(get_simulator_size)
          print_info "Old Size: $START_SIM_SIZE -> New: $END_SIM_SIZE"
          print_info "Cleanup Done."
          print_info "Cleanup Done."
        
